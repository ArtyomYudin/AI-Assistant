# RAG Project ‚Äî –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä (Streaming + FastAPI + Gradio + Test Evaluator)

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- üìÇ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö PDF / MD / TXT (–ø–∞–ø–∫–∞ `scraped_data/`)  
- üîç –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ **Milvus** (Hybrid: Dense + BM25 sparse)  
- üßπ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ SHA-256  
- ‚öñÔ∏è Rerank (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ vLLM endpoint)
- –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–π (Embedding –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, Embedding –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
- üí¨ –í–æ–ø—Ä–æ—Å‚Äì–æ—Ç–≤–µ—Ç —Å **–ø–æ—Ç–æ–∫–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (streaming)**  
- üåê API –Ω–∞ **FastAPI** (StreamingResponse + SSE)  
- üñ• UI –Ω–∞ **Gradio** (—á–∞—Ç + —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)  
- ‚úÖ –ú–æ–¥—É–ª—å —Ç–µ—Å—Ç-–æ—Ü–µ–Ω–∫–∏ –æ—Ç–≤–µ—Ç–∞ (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ + –º–µ—Ç—Ä–∏–∫–∏)  

---

## ‚ö° –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```text
–î–∞–Ω–Ω—ã–µ (PDF/MD/TXT) ‚Üí –ß–∞–Ω–∫–æ–≤–∞–Ω–∏–µ ‚Üí Embeddings ‚Üí Milvus (dense + BM25)
                                                  ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚ñº
–ó–∞–ø—Ä–æ—Å ‚Üí Embedding ‚Üí Milvus Hybrid Search ‚Üí [–æ–ø—Ü. MMR] ‚Üí [–æ–ø—Ü. Reranker] ‚Üí LLM (vLLM)
        ‚ñº
    –û—Ç–≤–µ—Ç (Streaming/SSE) + –õ–æ–≥–∏
```

---

## üèÅ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
pip install -r requirements.txt
```

### 2. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ
–ü–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª—ã –≤ `scraped_data/`.

### 3. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è + –¥–µ–º–æ (CLI)
```bash
python -m main
```

### 4. –ó–∞–ø—É—Å–∫ FastAPI
```bash
uvicorn api.app:app --host 0.0.0.0 --port 8000 --reload
```

Endpoints:
- `POST /index` ‚Äî –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (—á–∏—Ç–∞–µ—Ç `scraped_data/`)  
- `POST /ask/stream` ‚Äî —Å—Ç—Ä–∏–º–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞  
- `GET /ask/sse?question=...` ‚Äî SSE (text/event-stream)  
- `POST /test/stream` ‚Äî –æ—Ç–≤–µ—Ç + –º–µ—Ç—Ä–∏–∫–∏ –≤ JSON-–º–∞—Ä–∫–µ—Ä–µ  

### 5. Gradio UI
```bash
python -m ui.app
```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
(—Å–º. `config/rag_config.py`)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|------------------------|
| `RAG_LLM_NAME` | LLM –º–æ–¥–µ–ª—å | Qwen3-8B-AWQ |
| `RAG_LLM_BASE_URL` | OpenAI-compatible endpoint | http://localhost:8000/v1 |
| `RAG_EMBEDDING_NAME` | embedding –º–æ–¥–µ–ª—å | multilingual-e5-large |
| `RAG_EMBEDDING_BASE_URL` | endpoint –¥–ª—è embedding | http://localhost:8000/v1 |
| `RAG_MILVUS_URI` | Milvus URI | http://localhost:19530 |
| `RAG_COLLECTION` | –∏–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ | demo_ci_rag |
| `RAG_RECREATE_COLLECTION` | –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é | false |
| `RAG_CHECK_DUPLICATES` | –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ | true |
| `RAG_CHUNK_SIZE` / `RAG_CHUNK_OVERLAP` | –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∞–Ω–∫–æ–≤–∞–Ω–∏—è | 512 / 128 |
| `RAG_K` / `RAG_FETCH_K` | top_k / fetch_k –¥–ª—è –ø–æ–∏—Å–∫–∞ | 7 / 15 |
| `RAG_RERANKER_BASE_URL` | endpoint –¥–ª—è reranker | (–æ–ø—Ü.) |
| `RAG_MAX_CONTEXT_TOKENS` | –º–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ | 8192 |
| `RAG_RESERVED_FOR_COMPLETION` | –∑–∞–ø–∞—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | 2048 |
| `RAG_RESERVED_FOR_OVERHEAD` | –∑–∞–ø–∞—Å –ø–æ–¥ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã | 512 |

---

## üñ•Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–•–æ—Å—Ç:**  
```
IBM x3650 M5, 2√ó E5-2695 v3, 96GB RAM  
2√ó AMD Instinct MI50 (16GB)  
Ubuntu 24.04 + ROCm 6.3  
vLLM 0.92
```

---

## üß† –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏

**LLM:**
- Qwen3-8B-AWQ

**Embeddings:**
- multilingual-e5-large ‚úÖ (–ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä—É—Å—Å–∫–∏–º)  
- Qwen3-Embedding-4B ‚ùå –ø–ª–æ—Ö–æ —Å —Ä—É—Å—Å–∫–∏–º  
- BGE-3m ‚ùå –ø–ª–æ—Ö–æ —Å —Ä—É—Å—Å–∫–∏–º  
- e5-mistral-7b-instruct ‚ùå –æ—à–∏–±–∫–∞ `Token id 98285 is out of vocabulary`  
- Giga-Embeddings-instruct ‚ùå –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ vLLM

---

## üìå TODO
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ (Redis)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ (Redis)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ Gradio –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ Redis
- [ ] –î–æ–±–∞–≤–∏—Ç—å Maximal Marginal Relevance (MMR) –¥–ª—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤  
- [ ] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö  
- [ ] –í—ã–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `.env`  
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ LLM –º–æ–¥–µ–ª–µ–π  

---

## üîé –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –∫ embedding API
```bash
curl http://localhost:8000/v1/embeddings   -H "Content-Type: application/json"   -d '{
        "model": "ai-forever/FRIDA",
        "input": ["–ü—Ä–∏–≤–µ—Ç –º–∏—Ä", "–ö–∞–∫ –¥–µ–ª–∞?"]
      }'
```